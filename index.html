<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oggetti Smarriti Grosseto</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.0/dist/browser-image-compression.js"></script>

    <style>
        /* Layout Mobile Full Height */
        body { height: 100vh; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Mappa e Loader */
        #map { height: 250px; width: 100%; border-radius: 0.5rem; margin-bottom: 1rem; z-index: 1; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 90px; /* Pi√π alto per non coprire la nav bar */
            transform: translateX(-50%);
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }

        /* Categorie Scrollabili */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; cursor: grab; }
        .hide-scroll:active { cursor: grabbing; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- 1. HEADER FISSO (Logo + Auth) -->
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md shrink-0 z-50">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üîç</span>
            <h1 class="font-bold text-lg leading-none">Grosseto<br><span class="text-blue-200 text-sm font-normal">Oggetti Smarriti</span></h1>
        </div>
        <div>
            <button id="loginBtn" onclick="login()" class="text-xs bg-white text-blue-600 px-3 py-1.5 rounded font-bold hidden shadow">ACCEDI</button>
            <button id="logoutBtn" onclick="logout()" class="text-xs bg-blue-800 text-white px-3 py-1.5 rounded hidden">ESCI</button>
        </div>
    </header>

    <!-- 2. SEARCH BAR & FILTRI (Fissi sotto l'header, visibili solo in Lista) -->
    <div id="stickyFilters" class="bg-white border-b p-3 shrink-0 z-40 shadow-sm">
        <!-- Ricerca -->
        <div class="relative mb-3">
            <input type="text" id="searchBar" onkeyup="loadItems()" placeholder="Cerca oggetto..." class="w-full bg-gray-100 text-gray-700 p-2 pl-9 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="absolute left-3 top-2 text-gray-400 text-sm">üîç</span>
        </div>
        <!-- Categorie -->
        <div class="flex gap-2 overflow-x-auto hide-scroll pb-1 select-none" id="categoryFilters">
            <!-- Popolato via JS -->
        </div>
    </div>

    <!-- 3. AREA CONTENUTO SCROLLABILE -->
    <main id="mainScroll" class="flex-1 overflow-y-auto p-4 relative bg-gray-100 pb-24"> <!-- pb-24 per spazio nav bar -->
        
        <!-- SEZIONE LISTA -->
        <div id="listSection">
            <div id="itemsContainer" class="space-y-3">
                <p class="text-center text-gray-500 mt-10">Caricamento...</p>
            </div>
        </div>

        <!-- SEZIONE AGGIUNGI -->
        <div id="addSection" class="hidden max-w-lg mx-auto bg-white p-5 rounded-xl shadow-sm">
            <h2 class="text-xl font-bold mb-1">Nuova Segnalazione</h2>
            <p class="text-gray-500 text-sm mb-4">Compila i dati per aiutare la ricerca.</p>
            
            <div id="loginWarning" class="text-center py-8 hidden bg-blue-50 rounded-lg border border-blue-100">
                <p class="mb-3 text-blue-800 font-medium">Accedi per segnalare un oggetto.</p>
                <button onclick="login()" class="bg-blue-600 text-white px-6 py-2 rounded shadow">Login con Google</button>
            </div>

            <form id="addForm" onsubmit="submitItem(event)">
                <!-- Categoria -->
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Categoria</label>
                <div class="relative mb-4">
                    <select id="catSelect" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg appearance-none focus:outline-none focus:border-blue-500" required></select>
                    <span class="absolute right-3 top-3 text-gray-400">‚ñº</span>
                </div>

                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Titolo</label>
                <input type="text" id="title" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 focus:outline-none focus:border-blue-500" placeholder="Es. Chiavi Fiat" required>

                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Descrizione</label>
                <textarea id="desc" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 h-24 focus:outline-none focus:border-blue-500" placeholder="Colore, portachiavi, zona..." required></textarea>

                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Foto</label>
                <input type="file" id="photo" accept="image/*" class="w-full mb-4 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">

                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Dove (Tocca la mappa)</label>
                <div id="map" class="border border-gray-200"></div>
                <input type="hidden" id="lat"><input type="hidden" id="lng">

                <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg mt-2 active:scale-95 transition-transform">
                    PUBBLICA
                </button>
            </form>
        </div>

        <!-- SEZIONE ADMIN -->
        <div id="adminSection" class="hidden max-w-lg mx-auto">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Amministrazione</h2>
            <div id="adminList" class="space-y-2"></div>
        </div>
    </main>

    <!-- 4. BOTTOM NAV BAR (Fissa in basso) -->
    <nav class="bg-white border-t border-gray-200 flex justify-around items-center h-16 shrink-0 pb-safe z-50 safe-area-pb">
        <button onclick="showSection('list')" id="nav-list" class="flex flex-col items-center justify-center w-full h-full text-blue-600">
            <span class="text-2xl mb-1">üìã</span>
            <span class="text-[10px] font-bold uppercase tracking-wide">Lista</span>
        </button>
        
        <button onclick="showSection('add')" id="nav-add" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500">
            <div class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg -mt-6 border-4 border-white">
                <span class="text-2xl font-bold">+</span>
            </div>
            <span class="text-[10px] font-bold uppercase tracking-wide mt-1">Segnala</span>
        </button>
        
        <button onclick="showSection('admin')" id="nav-admin" class="flex flex-col items-center justify-center w-full h-full text-gray-400 hidden">
            <span class="text-2xl mb-1">‚öôÔ∏è</span>
            <span class="text-[10px] font-bold uppercase tracking-wide">Admin</span>
        </button>
    </nav>

    <!-- MODALI E TOAST -->
    <div id="fbModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl max-w-xs w-full mx-4 text-center shadow-2xl">
            <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">‚úÖ</div>
            <h3 class="text-lg font-bold mb-1">Oggetto Pubblicato!</h3>
            <p class="text-xs text-gray-500 mb-4">Per massima visibilit√†, condividi ora sul gruppo Facebook.</p>
            <textarea id="fbText" class="w-full border p-3 text-xs bg-gray-50 h-20 mb-4 rounded-lg resize-none focus:outline-none" readonly></textarea>
            <button onclick="copyAndGoToFb()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mb-2 shadow-md">
                Copia e Vai su Facebook
            </button>
            <button onclick="document.getElementById('fbModal').classList.add('hidden')" class="text-gray-400 text-xs py-2">Chiudi</button>
        </div>
    </div>

    <div id="toast">Messaggio</div>

    <script>
        // --- CONFIGURAZIONE ---
        const SUPABASE_URL = 'https://xgfdlyymbvpdnmomcxhd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnZmRseXltYnZwZG5tb21jeGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDIzOTgsImV4cCI6MjA3ODc3ODM5OH0.LJB7E--yAm5Nyxti749HVbxskjbURpKGuqK2c2hRBQs'; 
        const FB_GROUP_URL = 'https://www.facebook.com/groups/1636621146667765/';
        const BUCKET_NAME = 'oggetti-photos';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let isAdmin = false;
        let map, marker;

        const CATEGORIES = ['Chiavi', 'Documenti', 'Elettronica', 'Animali', 'Abbigliamento', 'Gioielli', 'Altro'];
        let currentFilter = 'Tutti';

        // --- INIZIALIZZAZIONE ---
        async function init() {
            await checkUser();
            initMap();
            renderCategories();
            enableDragScroll();
            loadItems();
        }

        // --- UI LOGIC ---
        function renderCategories() {
            const select = document.getElementById('catSelect');
            select.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');

            const filtersDiv = document.getElementById('categoryFilters');
            const allCats = ['Tutti', ...CATEGORIES];
            filtersDiv.innerHTML = allCats.map(c => `
                <button onclick="setFilter('${c}')" id="btn-cat-${c}"
                    class="px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-all ${c === 'Tutti' ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200'}">
                    ${c}
                </button>
            `).join('');
        }

        function enableDragScroll() {
            const slider = document.getElementById('categoryFilters');
            let isDown = false, startX, scrollLeft;
            slider.addEventListener('mousedown', (e) => { isDown=true; startX=e.pageX-slider.offsetLeft; scrollLeft=slider.scrollLeft; });
            slider.addEventListener('mouseleave', () => { isDown=false; });
            slider.addEventListener('mouseup', () => { isDown=false; });
            slider.addEventListener('mousemove', (e) => { if(!isDown)return; e.preventDefault(); const x=e.pageX-slider.offsetLeft; slider.scrollLeft=scrollLeft-(x-startX)*2; });
        }

        function setFilter(category) {
            currentFilter = category;
            document.querySelectorAll('#categoryFilters button').forEach(btn => {
                btn.className = "px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-all bg-white text-gray-600 border-gray-200";
            });
            document.getElementById(`btn-cat-${category}`).className = "px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-all bg-gray-800 text-white border-gray-800 shadow-md transform scale-105";
            loadItems();
        }

        function showSection(id) {
            // Gestione visibilit√† sezioni
            document.getElementById('listSection').classList.add('hidden');
            document.getElementById('addSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById(id + 'Section').classList.remove('hidden');

            // Gestione visibilit√† filtri sticky (Solo in lista)
            const stickyFilters = document.getElementById('stickyFilters');
            if (id === 'list') stickyFilters.classList.remove('hidden');
            else stickyFilters.classList.add('hidden');

            // Gestione Tab Bar attiva
            document.getElementById('nav-list').className = "flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500";
            document.getElementById('nav-add').className = "flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500";
            
            // Stile speciale per il bottone centrale Add
            const addIconDiv = document.querySelector('#nav-add div');
            if(id === 'add') {
                document.getElementById('nav-add').classList.add('text-blue-600');
                addIconDiv.className = "bg-blue-700 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg -mt-6 border-4 border-white transform scale-110 transition";
            } else {
                addIconDiv.className = "bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg -mt-6 border-4 border-white transition";
            }

            if (id === 'list') document.getElementById('nav-list').className = "flex flex-col items-center justify-center w-full h-full text-blue-600";

            if(id === 'add') setTimeout(() => map.invalidateSize(), 200);
            if(id === 'admin') loadAdminPanel();
        }

        // --- MAPPA ---
        function initMap() {
            map = L.map('map').setView([42.7600, 11.1100], 14); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
            map.on('click', function(e) {
                if (marker) map.removeLayer(marker);
                marker = L.marker(e.latlng).addTo(map);
                document.getElementById('lat').value = e.latlng.lat;
                document.getElementById('lng').value = e.latlng.lng;
            });
        }

        // --- DATA FETCHING (CON CONTATTO EMAIL) ---
        async function loadItems() {
            const container = document.getElementById('itemsContainer');
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            container.innerHTML = `<div class="text-center py-10"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto"></div></div>`;

            let query = supabase
                .from('oggetti_smarriti')
                .select(`*, profiles(email)`) // FIX: Query semplificata grazie al fix SQL
                .order('created_at', { ascending: false });

            if (currentFilter !== 'Tutti') query = query.eq('categoria', currentFilter);
            if (searchTerm) query = query.or(`titolo.ilike.%${searchTerm}%,descrizione.ilike.%${searchTerm}%`);

            const { data: items, error } = await query;

            if (error) { container.innerHTML = `<p class="text-red-500 text-center text-sm">Errore: ${error.message}</p>`; return; }
            
            if (items.length === 0) {
                 container.innerHTML = `<div class="text-center py-16 flex flex-col items-center">
                    <div class="bg-gray-200 p-4 rounded-full mb-3 text-3xl">üì≠</div>
                    <p class="text-gray-500 font-medium">Nessun oggetto trovato</p>
                    <p class="text-gray-400 text-xs mt-1">Prova a cambiare filtro</p>
                 </div>`;
                 return;
            }

            container.innerHTML = items.map(item => {
                const ownerEmail = item.profiles?.email; // FIX: Accesso diretto a profiles
                const isOwner = currentUser && currentUser.id === item.user_id;
                const canDelete = isOwner || isAdmin;

                return `
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3">
                    <div class="w-24 h-24 shrink-0 rounded-lg bg-gray-100 overflow-hidden relative">
                        ${item.foto_url ? `<img src="${item.foto_url}" class="w-full h-full object-cover" onclick="window.open('${item.foto_url}', '_blank')">` : '<div class="flex items-center justify-center h-full text-gray-300 text-2xl">üì∑</div>'}
                    </div>
                    
                    <div class="flex-1 min-w-0 flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-1">
                                <span class="bg-blue-50 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider">${item.categoria || 'Altro'}</span>
                                <span class="text-[10px] text-gray-400">${new Date(item.created_at).toLocaleDateString()}</span>
                            </div>
                            <h3 class="font-bold text-gray-800 text-base leading-tight mb-1 truncate">${item.titolo}</h3>
                            <p class="text-gray-500 text-xs line-clamp-2 leading-relaxed">${item.descrizione}</p>
                        </div>

                        <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-50">
                            <div class="flex gap-2">
                                ${item.latitudine ? `<a href="https://www.google.com/maps/search/?api=1&query=${item.latitudine},${item.longitudine}" target="_blank" class="text-gray-500 hover:text-blue-600 text-xs flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border border-gray-100">üìç Mappa</a>` : ''}
                                
                                ${(!isOwner && currentUser && ownerEmail) ? 
                                    `<a href="mailto:${ownerEmail}?subject=Oggetto Smarrito: ${item.titolo}" class="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1 bg-blue-50 px-2 py-1 rounded border border-blue-100 font-semibold">‚úâÔ∏è Contatta</a>` 
                                    : ''}
                            </div>

                            ${canDelete ? 
                                `<button onclick="deleteItem(${item.id})" class="text-red-500 text-xs font-medium px-2 py-1 hover:bg-red-50 rounded">üóëÔ∏è Elimina</button>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        // --- ACTIONS ---
        async function submitItem(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = "‚è≥ Caricamento..."; btn.disabled = true;

            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const cat = document.getElementById('catSelect').value;
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const fileInput = document.getElementById('photo');
            let publicUrl = null;

            if (fileInput.files.length > 0) {
                try {
                    const imageFile = fileInput.files[0];
                    const compressedFile = await imageCompression(imageFile, { maxSizeMB: 0.5, maxWidthOrHeight: 1024 });
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}`;
                    const { error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, compressedFile);
                    if (error) throw error;
                    const { data: urlData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileName);
                    publicUrl = urlData.publicUrl;
                } catch (err) {
                    showToast("Errore foto: " + err.message);
                    btn.innerText = "RIPROVA"; btn.disabled = false; return;
                }
            }

            const { error } = await supabase.from('oggetti_smarriti').insert({
                titolo: title, descrizione: desc, categoria: cat,
                latitudine: lat || null, longitudine: lng || null, foto_url: publicUrl
            });

            if (error) showToast("Errore: " + error.message);
            else {
                document.getElementById('fbText').value = `üîç SMARRITO/RITROVATO: ${cat.toUpperCase()}\nCosa: ${title}\nInfo: ${desc}\n\nVedi dettagli: ${window.location.href}`;
                document.getElementById('fbModal').classList.remove('hidden');
                e.target.reset();
                if(marker) map.removeLayer(marker);
                showSection('list');
                loadItems();
            }
            btn.innerText = "PUBBLICA"; btn.disabled = false;
        }

        async function deleteItem(id) {
             if(!confirm("Sei sicuro? Se hai ritrovato l'oggetto, confermando lo rimuoverai dalla lista.")) return; 
            await supabase.from('oggetti_smarriti').delete().eq('id', id);
            loadItems();
            showToast("Oggetto rimosso!");
        }

        // --- AUTH & ADMIN ---
        async function checkUser() {
            const { data: { session } } = await supabase.auth.getSession();
            currentUser = session?.user;
            
            if (currentUser) {
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('logoutBtn').classList.remove('hidden');
                document.getElementById('addForm').classList.remove('hidden');
                document.getElementById('loginWarning').classList.add('hidden');
                const { data } = await supabase.rpc('am_i_admin');
                if (data === true) {
                    isAdmin = true;
                    document.getElementById('nav-admin').classList.remove('hidden');
                }
            } else {
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                document.getElementById('addForm').classList.add('hidden');
                document.getElementById('loginWarning').classList.remove('hidden');
            }
        }

        async function login() {
            const redirectUrl = 'https://infomichelerosati.github.io/oggetti-smarriti/'; 
            await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: redirectUrl } });
        }
        async function logout() { await supabase.auth.signOut(); window.location.reload(); }
        
        function copyAndGoToFb() {
            const text = document.getElementById('fbText');
            navigator.clipboard.writeText(text.value).then(() => window.open(FB_GROUP_URL, '_blank'))
            .catch(() => { text.select(); document.execCommand("copy"); window.open(FB_GROUP_URL, '_blank'); });
            document.getElementById('fbModal').classList.add('hidden');
        }
        function showToast(msg) {
            const toast = document.getElementById("toast");
            toast.innerText = msg; toast.className = "show";
            setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
        }
        
        // Admin logic simplified for brevity (same as before)
        async function loadAdminPanel() {
            const container = document.getElementById('adminList');
            container.innerHTML = "Loading...";
            const { data } = await supabase.from('profiles').select('*');
            if(!data) return;
            container.innerHTML = data.map(p => `<div class='p-2 border-b text-xs'>${p.email} (Admin: ${p.is_admin})</div>`).join('');
        }

        init();
    </script>
</body>
</html>
