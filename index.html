<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Oggetti Smarriti Grosseto</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet + MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Image Compression -->
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.0/dist/browser-image-compression.js"></script>

    <style>
        body { height: 100vh; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        #map, #viewMap { height: 250px; width: 100%; border-radius: 0.5rem; margin-bottom: 1rem; z-index: 1; }
        #globalMap { height: 100%; width: 100%; z-index: 1; }
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 90px; transform: translateX(-50%); font-size: 17px; opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; cursor: grab; }
        .hide-scroll:active { cursor: grabbing; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; font-weight: bold; display: none; }
        .footer-link { font-size: 10px; color: #9ca3af; text-decoration: underline; cursor: pointer; margin-top: 10px; display: block; text-align: center; }
        /* Leaflet Fixes */
        .leaflet-pane { z-index: 10 !important; }
        .leaflet-top, .leaflet-bottom { z-index: 20 !important; }
        .custom-popup .leaflet-popup-content-wrapper { padding: 0; overflow: hidden; border-radius: 8px; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 200px !important; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <!-- HEADER -->
    <header class="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md shrink-0 z-50">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üîç</span>
            <h1 class="font-bold text-lg leading-none">Grosseto<br><span class="text-blue-200 text-sm font-normal">Oggetti Smarriti</span></h1>
        </div>
        <div class="flex gap-3 items-center">
            <button onclick="openHelpModal()" class="text-2xl hover:scale-110 transition-transform" title="Istruzioni">üìò</button>
            <button id="inboxBtn" onclick="showInbox()" class="relative hidden text-2xl">üîî<span id="msgBadge" class="notification-badge">0</span></button>
            
            <!-- Tasto Login / Profilo -->
            <button id="loginBtn" onclick="openAuthModal()" class="text-xs bg-white text-blue-600 px-3 py-1.5 rounded font-bold hidden shadow">ACCEDI</button>
            <button id="profileBtn" onclick="openProfileModal()" class="hidden bg-blue-800 rounded-full w-8 h-8 flex items-center justify-center border border-blue-400 shadow hover:bg-blue-700">üë§</button>
        </div>
    </header>

    <!-- PENDING ALERT -->
    <div id="pendingAlert" class="hidden bg-yellow-100 border-b border-yellow-200 p-3 text-center text-yellow-800 text-sm font-medium">
        ‚è≥ Account in attesa di approvazione.<br>Non puoi ancora pubblicare o inviare messaggi.
    </div>

    <!-- FILTRI -->
    <div id="stickyFilters" class="bg-white border-b p-3 shrink-0 z-40 shadow-sm">
        <div class="relative mb-3">
            <input type="text" id="searchBar" onkeyup="loadItems()" placeholder="Cerca oggetto..." class="w-full bg-gray-100 text-gray-700 p-2 pl-9 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
            <span class="absolute left-3 top-2 text-gray-400 text-sm">üîç</span>
        </div>
        <div class="flex gap-2 overflow-x-auto hide-scroll pb-1 select-none" id="categoryFilters"></div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="mainScroll" class="flex-1 overflow-y-auto relative bg-gray-100">
        
        <!-- LIST SECTION -->
        <div id="listSection" class="p-4 pb-24">
            <div id="itemsContainer" class="space-y-3">
                <p class="text-center text-gray-500 mt-10">Caricamento...</p>
            </div>
            <!-- FOOTER LINK -->
            <div class="pb-8 pt-4">
                <span onclick="openPolicyModal()" class="footer-link">Privacy Policy & Termini di utilizzo</span>
                <p class="text-[10px] text-gray-400 text-center mt-1">Servizio gratuito offerto alla comunit√†.</p>
            </div>
        </div>

        <!-- GLOBAL MAP SECTION (CLUSTERING) -->
        <div id="mapSection" class="hidden w-full h-full relative">
            <div id="globalMap"></div>
            <div class="absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-white px-4 py-2 rounded-full shadow-lg z-[30] text-xs font-bold text-gray-600 border border-gray-200 pointer-events-none opacity-90">
                Tocca i cerchi per espandere
            </div>
        </div>

        <!-- ADD SECTION -->
        <div id="addSection" class="hidden p-4 max-w-lg mx-auto bg-white min-h-full">
            <h2 class="text-xl font-bold mb-1">Nuova Segnalazione</h2>
            <p class="text-gray-500 text-sm mb-4">Compila i dati per aiutare la ricerca.</p>
            <div id="loginWarning" class="text-center py-8 hidden bg-blue-50 rounded-lg border border-blue-100">
                <p id="warningText" class="mb-3 text-blue-800 font-medium">Accedi per segnalare un oggetto.</p>
                <button id="warningBtn" onclick="openAuthModal()" class="bg-blue-600 text-white px-6 py-2 rounded shadow">Accedi / Registrati</button>
                <p class="text-[10px] text-gray-500 mt-3 px-4">Continuando accetti la Privacy Policy.</p>
            </div>
            <form id="addForm" onsubmit="submitItem(event)">
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Categoria</label>
                <div class="relative mb-4">
                    <select id="catSelect" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg appearance-none focus:outline-none focus:border-blue-500" required></select>
                    <span class="absolute right-3 top-3 text-gray-400">‚ñº</span>
                </div>
                
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Quando (Smarrito/Ritrovato)</label>
                <input type="date" id="dateLost" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 focus:outline-none focus:border-blue-500" required>

                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Titolo</label>
                <input type="text" id="title" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 focus:outline-none focus:border-blue-500" placeholder="Es. Chiavi Fiat" required>
                
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Descrizione</label>
                <textarea id="desc" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg mb-4 h-24 focus:outline-none focus:border-blue-500" placeholder="Colore, portachiavi, zona..." required></textarea>
                
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Foto</label>
                <input type="file" id="photo" accept="image/*" class="w-full mb-4 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                
                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Dove (Tocca la mappa)</label>
                <p class="text-[10px] text-red-500 mb-1 font-bold">‚ö†Ô∏è Indica luogo pubblico, NON casa tua!</p>
                <div id="map" class="border border-gray-200"></div>
                <input type="hidden" id="lat"><input type="hidden" id="lng">
                
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg mt-2 active:scale-95 transition-transform">PUBBLICA</button>
            </form>
        </div>

        <!-- INBOX SECTION -->
        <div id="inboxSection" class="hidden p-4 max-w-lg mx-auto">
            <h2 class="text-xl font-bold mb-4 text-gray-800">Messaggi Ricevuti</h2>
            <div id="inboxList" class="space-y-3"><p class="text-gray-500 text-center mt-8">Nessun messaggio.</p></div>
            <button onclick="showSection('list')" class="mt-6 w-full py-3 text-blue-600 font-bold border border-blue-600 rounded-lg">Torna alla Lista</button>
        </div>

        <!-- ADMIN SECTION -->
        <div id="adminSection" class="hidden p-4 max-w-lg mx-auto">
            <h2 class="text-xl font-bold mb-2 text-gray-800">Amministrazione</h2>
            <div class="relative mb-4">
                <input type="text" id="adminSearch" onkeyup="renderAdminList()" placeholder="Cerca email..." class="w-full p-2 pl-8 border rounded-lg text-sm bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <span class="absolute left-2 top-2 text-gray-400 text-sm">üîç</span>
            </div>
            <div id="adminList" class="space-y-2"></div>
        </div>
    </main>

    <!-- NAVBAR -->
    <nav class="bg-white border-t border-gray-200 flex justify-around items-center h-16 shrink-0 pb-safe z-50 safe-area-pb shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="showSection('list')" id="nav-list" class="nav-btn flex flex-col items-center justify-center w-full h-full text-blue-600">
            <span class="text-2xl mb-1">üìã</span><span class="text-[10px] font-bold uppercase tracking-wide">Lista</span>
        </button>
        <button onclick="showSection('map')" id="nav-map" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500">
            <span class="text-2xl mb-1">üó∫Ô∏è</span><span class="text-[10px] font-bold uppercase tracking-wide">Mappa</span>
        </button>
        <button onclick="showSection('add')" id="nav-add" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500 group">
            <div class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg -mt-6 border-4 border-white transition-transform group-hover:scale-110 group-active:scale-95"><span class="text-2xl font-bold">+</span></div>
            <span class="text-[10px] font-bold uppercase tracking-wide mt-1">Segnala</span>
        </button>
        <button onclick="showSection('admin')" id="nav-admin" class="nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hidden">
            <span class="text-2xl mb-1">‚öôÔ∏è</span><span class="text-[10px] font-bold uppercase tracking-wide">Admin</span>
        </button>
    </nav>

    <!-- MODALI -->
    
    <!-- PROFILO / LOGOUT / DELETE -->
    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl max-w-xs w-full shadow-2xl text-center">
            <h3 class="text-xl font-bold mb-2">Il tuo Profilo</h3>
            <p id="userEmailDisplay" class="text-sm text-gray-500 mb-6 break-all"></p>
            
            <button onclick="logout()" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl mb-3 hover:bg-gray-300">ESCI</button>
            
            <hr class="my-4 border-gray-200">
            
            <button onclick="deleteAccount()" class="w-full bg-red-50 text-red-600 border border-red-100 font-bold py-3 rounded-xl hover:bg-red-100 text-xs uppercase tracking-wider">‚ö†Ô∏è Elimina Account</button>
            
            <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="text-gray-400 text-sm py-3 mt-2 w-full">Chiudi</button>
        </div>
    </div>

    <!-- HELP MODAL -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl max-w-md w-full shadow-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">üìò Guida Rapida</h3>
                <button onclick="closeHelpModal()" class="text-gray-400 hover:text-gray-600 text-2xl">‚úï</button>
            </div>
            <div class="space-y-4 text-sm text-gray-700 overflow-y-auto pr-2">
                <p class="italic text-xs mb-2 text-gray-500">Benvenuto nella community! Ecco come funziona.</p>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <h4 class="font-bold text-gray-900 flex items-center gap-2 mb-1">üë§ Visitatore</h4>
                    <ul class="list-disc pl-5 text-xs space-y-1 text-gray-600">
                        <li><strong>Consultare:</strong> Vedi lista, mappa e foto degli oggetti.</li>
                        <li><strong>Cercare:</strong> Filtra per categoria o testo.</li>
                        <li><strong>Limiti:</strong> Non puoi segnalare o contattare senza account.</li>
                    </ul>
                </div>
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <h4 class="font-bold text-blue-900 flex items-center gap-2 mb-1">üîê Utente Registrato</h4>
                    <ul class="list-disc pl-5 text-xs space-y-1 text-gray-600">
                        <li><strong>Segnalare:</strong> Usa il tasto <strong>(+)</strong>. Foto e posizione mappa sono obbligatorie.</li>
                        <li><strong>Contattare:</strong> Premi <strong>üí¨ Contatta</strong> per scrivere al proprietario (Max 2 messaggi).</li>
                        <li><strong>Gestire:</strong> Premi <strong>‚úÖ Trovato!</strong> se hai risolto. Usa üóëÔ∏è per cancellare.</li>
                        <li><strong>Attesa:</strong> I nuovi account devono essere approvati da un Admin.</li>
                    </ul>
                </div>
                <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                    <h4 class="font-bold text-red-900 flex items-center gap-2 mb-1">‚ö†Ô∏è Sicurezza</h4>
                    <ul class="list-disc pl-5 text-xs space-y-1 text-gray-600">
                        <li><strong>Mappa:</strong> Indica SOLO luoghi pubblici (piazze, parchi). <strong>MAI casa tua.</strong></li>
                        <li><strong>Foto:</strong> Oscura dati sensibili se fotografi documenti.</li>
                        <li><strong>Incontri:</strong> Sempre in luoghi pubblici e frequentati.</li>
                    </ul>
                </div>
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                    <h4 class="font-bold text-gray-900 flex items-center gap-2 mb-1">üëÆ Admin</h4>
                    <p class="text-xs text-gray-600">Gestione utenti (approvazioni/ban) e pulizia oggetti ritrovati.</p>
                </div>
            </div>
            <button onclick="closeHelpModal()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mt-4 shadow hover:bg-blue-700 transition">Ho capito</button>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full shadow-2xl relative">
            <button onclick="closeAuthModal()" class="absolute top-2 right-2 text-gray-500 text-xl px-2">‚úï</button>
            <h3 id="authTitle" class="text-xl font-bold mb-4 text-center">Accedi</h3>
            
            <!-- GOOGLE LOGIN -->
            <button onclick="loginGoogle()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 rounded-lg shadow-sm flex items-center justify-center gap-2 mb-4 hover:bg-gray-50">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Accedi con Google
            </button>
            
            <div class="flex items-center my-4"><div class="flex-1 border-t border-gray-300"></div><span class="px-3 text-xs text-gray-500 font-bold">OPPURE</span><div class="flex-1 border-t border-gray-300"></div></div>

            <div id="emailForm" class="space-y-3">
                <input type="email" id="authEmail" placeholder="Email" class="w-full p-3 border rounded-lg text-sm">
                <input type="password" id="authPass" placeholder="Password" class="w-full p-3 border rounded-lg text-sm">
                <button id="authActionBtn" onclick="handleEmailAuth()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow">Accedi con Email</button>
            </div>
            <div class="mt-4 text-center text-sm">
                <span id="authSwitchText" class="text-gray-600">Non hai un account?</span>
                <button onclick="toggleAuthMode()" id="authSwitchBtn" class="text-blue-600 font-bold underline ml-1">Registrati</button>
            </div>
        </div>
    </div>

    <div id="viewMapModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white p-4 rounded-2xl max-w-sm w-full shadow-2xl relative">
            <button onclick="closeViewMap()" class="absolute top-2 right-2 text-gray-500 z-10 bg-white rounded-full p-1 w-8 h-8 flex items-center justify-center shadow">‚úï</button>
            <h3 id="viewMapTitle" class="text-lg font-bold mb-2 truncate pr-8">Posizione</h3>
            <div id="viewMap" class="border border-gray-200 z-0"></div>
            <div class="mt-3 flex justify-between gap-2">
                <button onclick="openExternalMap()" class="flex-1 bg-blue-600 text-white text-xs font-bold py-3 rounded-lg shadow">Apri navigatore</button>
            </div>
        </div>
    </div>

    <div id="viewImageModal" class="fixed inset-0 bg-black bg-opacity-95 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-0" onclick="closeImageModal()">
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white z-20 bg-gray-800 bg-opacity-50 rounded-full p-2 w-10 h-10 flex items-center justify-center shadow-lg border border-gray-600">‚úï</button>
        <img id="fullScreenImage" src="" class="max-h-screen max-w-full object-contain" alt="Oggetto">
    </div>

    <!-- CONTACT MODAL -->
    <div id="contactModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full shadow-2xl">
            <h3 class="text-lg font-bold mb-1">Contatta il proprietario</h3>
            
            <!-- WARNING LIMIT -->
            <div class="bg-yellow-50 border border-yellow-100 text-yellow-800 text-xs p-2 rounded mb-3">
                ‚ö†Ô∏è <strong>Attenzione:</strong> Hai a disposizione solo <strong>2 messaggi</strong> per questo annuncio. Scrivi subito il tuo numero o email per essere ricontattato.
            </div>

            <!-- CHECKBOX FOUND -->
            <label class="flex items-center gap-2 mb-3 cursor-pointer p-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                <input type="checkbox" id="foundCheck" class="w-5 h-5 text-green-600 rounded focus:ring-green-500 border-gray-300" onchange="toggleFoundMessage()">
                <span class="text-sm font-bold text-gray-700">üéâ Ho ritrovato l'oggetto!</span>
            </label>

            <textarea id="msgText" class="w-full border p-3 text-sm bg-gray-50 h-24 mb-4 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Scrivi qui il tuo messaggio..."></textarea>
            
            <input type="hidden" id="msgReceiverId"><input type="hidden" id="msgItemId">
            
            <button onclick="sendMessage()" id="sendMsgBtn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mb-2 shadow-md transition-colors">Invia Messaggio</button>
            <button onclick="closeContactModal()" class="w-full text-gray-500 text-sm py-2">Annulla</button>
        </div>
    </div>

    <div id="fbModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl max-w-xs w-full mx-4 text-center shadow-2xl">
            <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">‚úÖ</div>
            <h3 class="text-lg font-bold mb-1">Pubblicato!</h3>
            <textarea id="fbText" class="w-full border p-3 text-xs bg-gray-50 h-20 mb-4 rounded-lg resize-none" readonly></textarea>
            <button onclick="copyAndGoToFb()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl mb-2 shadow-md">Copia e Vai</button>
            <button onclick="document.getElementById('fbModal').classList.add('hidden')" class="text-gray-400 text-xs py-2">Chiudi</button>
        </div>
    </div>
    
    <!-- POLICY MODAL -->
    <div id="policyModal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-[100] backdrop-blur-sm p-4">
        <div class="bg-white p-6 rounded-2xl max-w-md w-full shadow-2xl max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-2">Privacy & Regole</h3>
            <div class="text-xs text-gray-600 space-y-2 mb-4 leading-relaxed">
                <p><strong>1. Gestione Dati:</strong> Questa applicazione √® un servizio gratuito offerto alla comunit√†. L'amministratore non ha fini di lucro. I dati (email, foto, posizione) sono salvati su Supabase (Piattaforma Cloud sicura) al solo scopo di permettere il ritrovamento degli oggetti.</p>
                <p><strong>2. Posizione e Sicurezza:</strong> La posizione indicata sulla mappa deve riferirsi <u>esclusivamente</u> al luogo dello smarrimento o del ritrovamento (es. una piazza, un parco). <strong>NON indicare mai il tuo indirizzo di casa</strong> o luoghi privati per la tua sicurezza.</p>
                <p><strong>3. Responsabilit√†:</strong> L'utente √® l'unico responsabile dei contenuti pubblicati. √à vietato pubblicare foto di documenti d'identit√† leggibili, dati sensibili altrui o contenuti offensivi.</p>
                <p><strong>4. Rimozione:</strong> Puoi cancellare i tuoi annunci in qualsiasi momento. Gli amministratori si riservano il diritto di rimuovere contenuti inappropriati e bannare utenti senza preavviso.</p>
                <p><strong>5. Contatti:</strong> Il sistema di messaggistica serve solo per accordarsi sul ritrovamento. √à vietato spam o molestie.</p>
            </div>
            <button onclick="document.getElementById('policyModal').classList.add('hidden')" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg">Chiudi</button>
        </div>
    </div>

    <div id="toast">Messaggio</div>

    <script>
        const SUPABASE_URL = 'https://xgfdlyymbvpdnmomcxhd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhnZmRseXltYnZwZG5tb21jeGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyMDIzOTgsImV4cCI6MjA3ODc3ODM5OH0.LJB7E--yAm5Nyxti749HVbxskjbURpKGuqK2c2hRBQs'; 
        const FB_GROUP_URL = 'https://www.facebook.com/groups/1636621146667765/';
        const BUCKET_NAME = 'oggetti-photos';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null;
        let userProfile = null; 
        let isAdmin = false;
        let isAuthorized = false;
        let map, marker;
        let viewMapInstance = null;
        let currentViewLat = 0;
        let currentViewLng = 0;
        let isLoginMode = true; 

        // MAPPA GLOBALE & CLUSTERING
        let globalMap = null;
        let markersClusterGroup = null; // Nuova variabile per il cluster
        let allItemsData = []; 

        // ADMIN CACHE
        let adminUsersCache = [];
        let adminFoundItemsCache = [];

        const CATEGORIES = ['Chiavi', 'Documenti', 'Borse/Zaini/Portafogli', 'Biciclette', 'Elettronica', 'Animali', 'Abbigliamento', 'Gioielli', 'Altro'];
        let currentFilter = 'Tutti';
        const MAX_MESSAGES = 2;

        async function init() {
            // Set data default a oggi
            document.getElementById('dateLost').valueAsDate = new Date();
            
            await checkUser();
            initMap(); 
            renderCategories();
            enableDragScroll();
            loadItems();
            if(currentUser && isAuthorized) checkMessages();
        }

        function openHelpModal() { document.getElementById('helpModal').classList.remove('hidden'); }
        function closeHelpModal() { document.getElementById('helpModal').classList.add('hidden'); }

        function openAuthModal() { document.getElementById('authModal').classList.remove('hidden'); isLoginMode = true; updateAuthUI(); }
        function closeAuthModal() { document.getElementById('authModal').classList.add('hidden'); document.getElementById('authEmail').value = ''; document.getElementById('authPass').value = ''; }
        function toggleAuthMode() { isLoginMode = !isLoginMode; updateAuthUI(); }
        
        // Gestione Profilo
        function openProfileModal() { 
            document.getElementById('userEmailDisplay').innerText = currentUser ? currentUser.email : '';
            document.getElementById('profileModal').classList.remove('hidden'); 
        }
        
        async function deleteAccount() {
            if(!confirm("SEI SICURO?\nQuesta azione eliminer√† PER SEMPRE tutti i tuoi dati, annunci e messaggi. Non si pu√≤ annullare.")) return;
            const btn = document.querySelector('#profileModal button.bg-red-50');
            btn.innerText = "ELIMINAZIONE..."; btn.disabled = true;

            try {
                // 1. Cancella oggetti (le policy permettono di cancellare i propri)
                const { error: errItems } = await supabase.from('oggetti_smarriti').delete().eq('user_id', currentUser.id);
                // 2. Cancella profilo (policy permette owner delete?) -> Se no, prova soft delete o basati su CASCADE
                // Per sicurezza con RLS standard, spesso serve cancellare il profilo per scatenare il resto se ci sono CASCADE FK.
                // Se non ci sono FK Cascade, cancelliamo manuale.
                
                // Proviamo a cancellare la riga profilo.
                const { error: errProfile } = await supabase.from('profiles').delete().eq('id', currentUser.id);
                
                if (errProfile) throw errProfile;

                await supabase.auth.signOut();
                window.location.reload();
            } catch (e) {
                alert("Errore eliminazione: " + e.message);
                btn.innerText = "‚ö†Ô∏è Elimina Account"; btn.disabled = false;
            }
        }

        function updateAuthUI() {
            const title = document.getElementById('authTitle'); const btn = document.getElementById('authActionBtn'); const switchText = document.getElementById('authSwitchText'); const switchBtn = document.getElementById('authSwitchBtn');
            if (isLoginMode) { title.innerText = "Accedi"; btn.innerText = "Accedi con Email"; switchText.innerText = "Non hai un account?"; switchBtn.innerText = "Registrati"; } 
            else { title.innerText = "Registrati"; btn.innerText = "Crea Account"; switchText.innerText = "Hai gi√† un account?"; switchBtn.innerText = "Accedi"; }
        }

        async function handleEmailAuth() {
            const email = document.getElementById('authEmail').value; const password = document.getElementById('authPass').value; const btn = document.getElementById('authActionBtn');
            if (!email || !password) { showToast("Inserisci email e password"); return; }
            btn.disabled = true; btn.innerText = "Attendi...";
            try {
                if (isLoginMode) {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error; closeAuthModal(); window.location.reload(); 
                } else {
                    const { data, error } = await supabase.auth.signUp({ email, password });
                    if (error) throw error;
                    if (data.session) { showToast("Registrazione completata!"); closeAuthModal(); window.location.reload(); } else { showToast("Controlla la tua email per confermare!"); closeAuthModal(); }
                }
            } catch (error) { showToast("Errore: " + (error.message === "Invalid login credentials" ? "Credenziali errate" : error.message)); } 
            finally { btn.disabled = false; updateAuthUI(); }
        }

        // NEW: Google Login
        async function loginGoogle() { 
            const redirectUrl = 'https://infomichelerosati.github.io/oggetti-smarriti/'; 
            await supabase.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: redirectUrl } }); 
        }

        async function logout() { await supabase.auth.signOut(); window.location.reload(); }

        function renderCategories() {
            const select = document.getElementById('catSelect');
            select.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('categoryFilters').innerHTML = ['Tutti', ...CATEGORIES].map(c => `<button onclick="setFilter('${c}')" id="btn-cat-${c}" class="px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-all ${c === 'Tutti' ? 'bg-gray-800 text-white border-gray-800' : 'bg-white text-gray-600 border-gray-200'}">${c}</button>`).join('');
        }

        function enableDragScroll() {
            const slider = document.getElementById('categoryFilters');
            let isDown = false, startX, scrollLeft;
            slider.addEventListener('mousedown', (e) => { isDown=true; startX=e.pageX-slider.offsetLeft; scrollLeft=slider.scrollLeft; });
            slider.addEventListener('mouseleave', () => { isDown=false; });
            slider.addEventListener('mouseup', () => { isDown=false; });
            slider.addEventListener('mousemove', (e) => { if(!isDown)return; e.preventDefault(); const x=e.pageX-slider.offsetLeft; slider.scrollLeft=scrollLeft-(x-startX)*2; });
        }

        function setFilter(category) {
            currentFilter = category;
            document.querySelectorAll('#categoryFilters button').forEach(btn => btn.className = "px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-all bg-white text-gray-600 border-gray-200");
            document.getElementById(`btn-cat-${category}`).className = "px-4 py-1.5 rounded-full text-xs font-medium whitespace-nowrap border transition-all bg-gray-800 text-white border-gray-800 shadow-md transform scale-105";
            loadItems();
        }

        function showSection(id) {
            ['listSection', 'addSection', 'adminSection', 'inboxSection', 'mapSection'].forEach(sid => document.getElementById(sid).classList.add('hidden'));
            document.getElementById(id + 'Section').classList.remove('hidden');
            
            const stickyFilters = document.getElementById('stickyFilters');
            if (id === 'list' || id === 'map') stickyFilters.classList.remove('hidden'); else stickyFilters.classList.add('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                // FIX: Manteniamo la classe 'hidden' se presente
                const isHidden = btn.classList.contains('hidden');
                btn.className = "nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 hover:text-blue-500";
                if (isHidden) btn.classList.add('hidden');
            });

            if (id === 'list') document.getElementById('nav-list').className = "nav-btn flex flex-col items-center justify-center w-full h-full text-blue-600";
            if (id === 'map') {
                document.getElementById('nav-map').className = "nav-btn flex flex-col items-center justify-center w-full h-full text-blue-600";
                initGlobalMap(); 
            }
            
            const addIconDiv = document.querySelector('#nav-add div');
            addIconDiv.className = "bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg -mt-6 border-4 border-white transition";

            if (id === 'add') {
                document.getElementById('nav-add').classList.add('text-blue-600');
                addIconDiv.className += " transform scale-110";
                setTimeout(() => map.invalidateSize(), 200);
            }
            if (id === 'admin') loadAdminPanel();
            if (id === 'inbox') loadInbox();
        }

        function initMap() {
            map = L.map('map').setView([42.7600, 11.1100], 14); 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
            map.on('click', function(e) {
                if (marker) map.removeLayer(marker);
                marker = L.marker(e.latlng).addTo(map);
                document.getElementById('lat').value = e.latlng.lat;
                document.getElementById('lng').value = e.latlng.lng;
            });
        }

        // --- MAPPA GLOBALE CON CLUSTERING ---
        function initGlobalMap() {
            if (!globalMap) {
                globalMap = L.map('globalMap').setView([42.7600, 11.1100], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(globalMap);
                // Crea il gruppo Cluster
                markersClusterGroup = L.markerClusterGroup(); 
                globalMap.addLayer(markersClusterGroup);
            }
            setTimeout(() => {
                globalMap.invalidateSize();
                renderGlobalMarkers();
            }, 100);
        }

        function renderGlobalMarkers() {
            if (!globalMap || !markersClusterGroup) return;
            markersClusterGroup.clearLayers(); // Pulisci il cluster, non la mappa diretta

            allItemsData.forEach(item => {
                if (item.latitudine && item.longitudine) {
                    const isRitrovato = item.stato === 'ritrovato';
                    const color = isRitrovato ? 'green' : 'red';
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background-color:${color}; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });

                    const marker = L.marker([item.latitudine, item.longitudine], {icon: icon});
                    
                    const safeTitle = item.titolo.replace(/'/g, "\\'");
                    const dateStr = item.data_smarrimento ? new Date(item.data_smarrimento).toLocaleDateString() : 'Data ignota';
                    
                    const popupContent = `
                        <div class="relative w-48 bg-white">
                            <div class="h-24 w-full bg-gray-100 overflow-hidden">
                                ${item.foto_url ? `<img src="${item.foto_url}" class="w-full h-full object-cover">` : '<div class="flex items-center justify-center h-full text-xs text-gray-400">No Foto</div>'}
                            </div>
                            <div class="p-2">
                                <p class="font-bold text-sm truncate">${item.titolo}</p>
                                <p class="text-[10px] text-gray-500 mb-1">${isRitrovato ? '‚úÖ RITROVATO' : 'üîç SMARRITO'}</p>
                                <p class="text-[10px] text-gray-400 mb-2">Data: ${dateStr}</p>
                                <button onclick="showItemDetailsFromMap('${item.id}')" class="w-full bg-blue-600 text-white text-xs py-1 rounded">Vedi Dettagli</button>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent, { className: 'custom-popup' });
                    markersClusterGroup.addLayer(marker); // Aggiungi al cluster
                }
            });
        }

        function showItemDetailsFromMap(itemId) {
            showSection('list');
            const el = document.getElementById(`item-${itemId}`);
            if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            else showToast("Oggetto nella lista...");
        }
        // --- END GLOBAL MAP ---

        function openViewMap(lat, lng, title) {
            currentViewLat = lat; currentViewLng = lng; document.getElementById('viewMapTitle').innerText = title; document.getElementById('viewMapModal').classList.remove('hidden');
            setTimeout(() => {
                if (!viewMapInstance) { viewMapInstance = L.map('viewMap').setView([lat, lng], 15); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(viewMapInstance); } else { viewMapInstance.setView([lat, lng], 15); }
                viewMapInstance.eachLayer((layer) => { if (layer instanceof L.Marker) viewMapInstance.removeLayer(layer); }); L.marker([lat, lng]).addTo(viewMapInstance); viewMapInstance.invalidateSize();
            }, 200);
        }
        function closeViewMap() { document.getElementById('viewMapModal').classList.add('hidden'); }
        function openExternalMap() { window.open(`https://www.google.com/maps/search/?api=1&query=${currentViewLat},${currentViewLng}`, '_blank'); }

        function openImageModal(url) { document.getElementById('fullScreenImage').src = url; document.getElementById('viewImageModal').classList.remove('hidden'); }
        function closeImageModal() { document.getElementById('viewImageModal').classList.add('hidden'); setTimeout(() => { document.getElementById('fullScreenImage').src = ''; }, 200); }

        // FUNZIONE PER ESPANDERE IL TESTO
        function toggleExpand(id) {
            const el = document.getElementById(`desc-${id}`);
            if (el) {
                el.classList.toggle('line-clamp-2');
            }
        }

        async function loadItems() {
            const container = document.getElementById('itemsContainer');
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            
            if(!document.getElementById('listSection').classList.contains('hidden')) {
                container.innerHTML = `<div class="text-center py-10"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto"></div></div>`;
            }

            let query = supabase.from('oggetti_smarriti').select(`*, profiles(email)`).order('created_at', { ascending: false });
            if (currentFilter !== 'Tutti') query = query.eq('categoria', currentFilter);
            if (searchTerm) query = query.or(`titolo.ilike.%${searchTerm}%,descrizione.ilike.%${searchTerm}%`);
            
            const { data: items, error } = await query;
            
            if (error) { container.innerHTML = `<p class="text-red-500 text-center text-sm">Errore: ${error.message}</p>`; return; }
            
            allItemsData = items || [];
            if(!document.getElementById('mapSection').classList.contains('hidden')) {
                renderGlobalMarkers(); 
            }

            if (items.length === 0) { container.innerHTML = `<div class="text-center py-16 flex flex-col items-center"><div class="bg-gray-200 p-4 rounded-full mb-3 text-3xl">üì≠</div><p class="text-gray-500 font-medium">Nessun oggetto trovato</p></div>`; return; }
            
            container.innerHTML = items.map(item => {
                const isOwner = currentUser && currentUser.id === item.user_id;
                const canDelete = isOwner || isAdmin;
                const isRitrovato = item.stato === 'ritrovato';
                const cardClass = isRitrovato ? "bg-white p-3 rounded-xl shadow-sm border border-green-400 bg-green-50 flex gap-3 opacity-90" : "bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex gap-3";
                const badge = isRitrovato ? `<span class="bg-green-600 text-white text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider">RITROVATO ‚úÖ</span>` : `<span class="bg-blue-50 text-blue-700 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wider">${item.categoria || 'Altro'}</span>`;
                const showContact = !isOwner && currentUser && isAuthorized && !isRitrovato;
                const safeTitle = item.titolo.replace(/'/g, "\\'");
                
                // Format Data Smarrimento
                const dataPerso = item.data_smarrimento ? new Date(item.data_smarrimento).toLocaleDateString() : '<span class="italic text-gray-300">Data ignota</span>';
                
                return `
                <div id="item-${item.id}" class="${cardClass}">
                    <div class="w-24 h-24 shrink-0 rounded-lg bg-gray-100 overflow-hidden relative cursor-pointer" ${item.foto_url ? `onclick="openImageModal('${item.foto_url}')"` : ''}>
                        ${item.foto_url ? `<img src="${item.foto_url}" class="w-full h-full object-cover">` : '<div class="flex items-center justify-center h-full text-gray-300 text-2xl">üì∑</div>'}
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-between">
                        <!-- CLICK WRAPPER PER ESPANDERE -->
                        <div onclick="toggleExpand('${item.id}')" class="cursor-pointer select-none">
                            <div class="flex justify-between items-start mb-1">${badge}<span class="text-[10px] text-gray-400">Pubblicato: ${new Date(item.created_at).toLocaleDateString()}</span></div>
                            <h3 class="font-bold text-gray-800 text-base leading-tight mb-1 truncate">${item.titolo}</h3>
                            <p class="text-[10px] text-gray-500 mb-1">üìÖ Data evento: <strong class="text-gray-700">${dataPerso}</strong></p>
                            <!-- DESCRIZIONE CON ID PER ESPANSIONE -->
                            <p id="desc-${item.id}" class="text-gray-500 text-xs line-clamp-2 leading-relaxed transition-all duration-200">${item.descrizione}</p>
                        </div>
                        
                        <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-50">
                            <div class="flex gap-2">
                                ${item.latitudine ? `<button onclick="openViewMap(${item.latitudine}, ${item.longitudine}, '${safeTitle}')" class="text-gray-500 hover:text-blue-600 text-xs flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border border-gray-100">üìç Mappa</button>` : ''}
                                ${showContact ? `<button onclick="openContactModal('${item.user_id}', '${item.id}')" class="text-blue-600 hover:text-blue-800 text-xs flex items-center gap-1 bg-blue-50 px-2 py-1 rounded border border-blue-100 font-semibold">üí¨ Contatta</button>` : ''}
                            </div>
                            <div class="flex gap-2">
                                ${(isOwner && !isRitrovato) ? `<button onclick="toggleStatus(${item.id}, 'ritrovato')" class="text-green-600 text-xs font-medium px-2 py-1 hover:bg-green-50 rounded border border-green-100">‚úÖ Trovato!</button>` : ''}
                                ${canDelete ? `<button onclick="deleteItem(${item.id})" class="text-red-500 text-xs font-medium px-2 py-1 hover:bg-red-50 rounded">üóëÔ∏è</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        async function toggleStatus(itemId, newStatus) {
            if(!confirm("Vuoi segnare questo oggetto come RITROVATO?")) return;
            const { error } = await supabase.from('oggetti_smarriti').update({ stato: newStatus }).eq('id', itemId);
            if(error) showToast("Errore: " + error.message); else { showToast("Stato aggiornato!"); loadItems(); }
        }

        function adminContactUser(userId, itemId, itemTitle) {
            openContactModal(userId, itemId);
            document.getElementById('msgText').value = `Ciao, ho visto che l'oggetto "${itemTitle}" √® segnato come ritrovato. Posso procedere alla cancellazione definitiva dall'app? Grazie, Admin.`;
        }

        // GESTIONE MESSAGGI RITROVAMENTO
        function openContactModal(receiverId, itemId) {
            if(!isAuthorized) { showToast("Utente non autorizzato."); return; }
            document.getElementById('msgReceiverId').value = receiverId;
            document.getElementById('msgItemId').value = itemId;
            
            // Reset Checkbox & Stile
            document.getElementById('foundCheck').checked = false;
            toggleFoundMessage(); 
            
            document.getElementById('contactModal').classList.remove('hidden');
        }

        function toggleFoundMessage() {
            const isFound = document.getElementById('foundCheck').checked;
            const btn = document.getElementById('sendMsgBtn');
            if (isFound) {
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.innerText = "INVIA SEGNALAZIONE RITROVAMENTO";
            } else {
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                btn.innerText = "Invia Messaggio";
            }
        }

        function closeContactModal() { 
            document.getElementById('contactModal').classList.add('hidden'); 
            document.getElementById('msgText').value = ''; 
        }
        
        function openPolicyModal() { document.getElementById('policyModal').classList.remove('hidden'); }

        async function sendMessage() {
            const receiverId = document.getElementById('msgReceiverId').value;
            const itemId = document.getElementById('msgItemId').value;
            let text = document.getElementById('msgText').value;
            const isFound = document.getElementById('foundCheck').checked;

            if(!text.trim()) { showToast("Scrivi un messaggio!"); return; }

            // Prefisso se ritrovato
            if (isFound) {
                text = "üéâ [OGGETTO RITROVATO] " + text;
            }

            if (!isAdmin) {
                const { count } = await supabase.from('messaggi').select('*', { count: 'exact', head: true }).eq('item_id', itemId).eq('sender_id', currentUser.id);
                if (count >= MAX_MESSAGES) { showToast(`Limite raggiunto (${MAX_MESSAGES} msg).`); closeContactModal(); return; }
            }
            const { error } = await supabase.from('messaggi').insert({ item_id: itemId, sender_id: currentUser.id, receiver_id: receiverId, testo: text });
            if(error) showToast("Errore: " + error.message); else { showToast("Messaggio inviato!"); closeContactModal(); }
        }

        async function checkMessages() {
            if(!currentUser) return;
            const { count } = await supabase.from('messaggi').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUser.id).eq('letto', false);
            const badge = document.getElementById('msgBadge');
            if(count > 0) { badge.innerText = count; badge.style.display = 'block'; } else { badge.style.display = 'none'; }
        }

        async function loadInbox() {
            if (!isAuthorized) return;
            const container = document.getElementById('inboxList'); container.innerHTML = "Caricamento...";
            const { data: messaggi, error } = await supabase.from('messaggi').select(`*, oggetti_smarriti(titolo)`).eq('receiver_id', currentUser.id).order('created_at', { ascending: false });
            if(error) { container.innerHTML = "Errore."; return; }
            if(messaggi.length === 0) { container.innerHTML = `<p class="text-center text-gray-500 mt-10">Nessun messaggio.</p>`; return; }
            container.innerHTML = messaggi.map(msg => `
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 ${!msg.letto ? 'border-l-4 border-l-blue-500' : ''}">
                    <div class="flex justify-between mb-2"><span class="font-bold text-xs uppercase text-gray-500">Rif: ${msg.oggetti_smarriti?.titolo || 'Oggetto eliminato'}</span><span class="text-[10px] text-gray-400">${new Date(msg.created_at).toLocaleDateString()}</span></div>
                    <p class="text-sm text-gray-800 mb-3 bg-gray-50 p-2 rounded">${msg.testo}</p>
                    ${!msg.letto ? `<button onclick="markAsRead(${msg.id})" class="text-xs text-blue-600 underline">Segna letto</button>` : '<span class="text-xs text-green-600">Letto</span>'}
                </div>
            `).join('');
        }
        async function markAsRead(msgId) { await supabase.from('messaggi').update({ letto: true }).eq('id', msgId); checkMessages(); loadInbox(); }
        function showInbox() { if(!isAuthorized) return; showSection('inbox'); }

        async function submitItem(e) {
            e.preventDefault();
            if (!isAuthorized) { showToast("Attendi approvazione admin."); return; }
            const btn = document.getElementById('submitBtn'); btn.innerHTML = "‚è≥ Caricamento..."; btn.disabled = true;
            const title = document.getElementById('title').value; 
            const desc = document.getElementById('desc').value; 
            const cat = document.getElementById('catSelect').value; 
            const lat = document.getElementById('lat').value; 
            const lng = document.getElementById('lng').value; 
            const dateLost = document.getElementById('dateLost').value; // Nuova Data
            const fileInput = document.getElementById('photo');
            
            let publicUrl = null;
            if (fileInput.files.length > 0) {
                try {
                    const imageFile = fileInput.files[0]; const compressedFile = await imageCompression(imageFile, { maxSizeMB: 0.5, maxWidthOrHeight: 1024 });
                    const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}`;
                    const { error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, compressedFile);
                    if (error) throw error; const { data: urlData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileName); publicUrl = urlData.publicUrl;
                } catch (err) { showToast("Errore foto: " + err.message); btn.innerText = "RIPROVA"; btn.disabled = false; return; }
            }
            
            const { error } = await supabase.from('oggetti_smarriti').insert({ 
                titolo: title, 
                descrizione: desc, 
                categoria: cat, 
                latitudine: lat || null, 
                longitudine: lng || null, 
                foto_url: publicUrl, 
                stato: 'attivo',
                data_smarrimento: dateLost || new Date().toISOString() // Salva data
            });
            
            if (error) showToast("Errore: " + error.message); else { document.getElementById('fbText').value = `üîç SMARRITO/RITROVATO: ${cat.toUpperCase()}\nCosa: ${title}\nData: ${new Date(dateLost).toLocaleDateString()}\nInfo: ${desc}\n\nVedi dettagli: ${window.location.href}`; document.getElementById('fbModal').classList.remove('hidden'); e.target.reset(); if(marker) map.removeLayer(marker); showSection('list'); loadItems(); }
            btn.innerText = "PUBBLICA"; btn.disabled = false;
        }
        
        async function deleteItem(id) { 
            if(!confirm("Sei sicuro?")) return; 
            const { data: item } = await supabase.from('oggetti_smarriti').select('foto_url').eq('id', id).single();
            if (item && item.foto_url) {
                try { const fileName = item.foto_url.split('/').pop(); await supabase.storage.from(BUCKET_NAME).remove([fileName]); } catch (err) { console.error("Errore cancellazione foto:", err); }
            }
            await supabase.from('oggetti_smarriti').delete().eq('id', id);
            loadItems(); 
            showToast("Rimosso!"); 
        }

        async function checkUser() {
            const { data: { session } } = await supabase.auth.getSession();
            currentUser = session?.user;
            
            const loginBtn = document.getElementById('loginBtn'); 
            const profileBtn = document.getElementById('profileBtn'); 
            const inboxBtn = document.getElementById('inboxBtn');
            const addForm = document.getElementById('addForm'); const loginWarning = document.getElementById('loginWarning'); const pendingAlert = document.getElementById('pendingAlert'); const navAdmin = document.getElementById('nav-admin');

            if (currentUser) {
                const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
                userProfile = profile;
                isAdmin = profile?.is_admin || false;
                isAuthorized = profile?.is_authorized || false;

                loginBtn.classList.add('hidden'); 
                profileBtn.classList.remove('hidden'); // Mostra profilo invece di logout

                if (isAuthorized) {
                    pendingAlert.classList.add('hidden'); addForm.classList.remove('hidden'); loginWarning.classList.add('hidden'); inboxBtn.classList.remove('hidden');
                    if (isAdmin) navAdmin.classList.remove('hidden');
                } else {
                    pendingAlert.classList.remove('hidden'); addForm.classList.add('hidden'); loginWarning.classList.remove('hidden');
                    document.getElementById('warningText').innerText = "Il tuo account √® in attesa di approvazione.";
                    document.getElementById('warningBtn').classList.add('hidden'); inboxBtn.classList.add('hidden'); navAdmin.classList.add('hidden');
                }
            } else {
                loginBtn.classList.remove('hidden'); 
                profileBtn.classList.add('hidden'); inboxBtn.classList.add('hidden'); pendingAlert.classList.add('hidden');
                addForm.classList.add('hidden'); loginWarning.classList.remove('hidden');
                document.getElementById('warningText').innerText = "Accedi per segnalare un oggetto.";
                document.getElementById('warningBtn').classList.remove('hidden'); navAdmin.classList.add('hidden');
            }
        }

        function copyAndGoToFb() { const text = document.getElementById('fbText'); navigator.clipboard.writeText(text.value).then(() => window.open(FB_GROUP_URL, '_blank')).catch(() => { text.select(); document.execCommand("copy"); window.open(FB_GROUP_URL, '_blank'); }); document.getElementById('fbModal').classList.add('hidden'); }
        function showToast(msg) { const toast = document.getElementById("toast"); toast.innerText = msg; toast.className = "show"; setTimeout(() => toast.className = toast.className.replace("show", ""), 3000); }

        // --- ADMIN PANEL ---
        async function loadAdminPanel() {
            const container = document.getElementById('adminList'); 
            container.innerHTML = '<div class="text-center"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8 mx-auto"></div></div>';
            const [usersRes, itemsRes] = await Promise.all([
                 supabase.from('profiles').select('*').order('email', {ascending: true}),
                 supabase.from('oggetti_smarriti').select('*, profiles(email)').eq('stato', 'ritrovato')
            ]);
            if (usersRes.error || itemsRes.error) { container.innerHTML = "Errore caricamento dati."; return; }
            adminUsersCache = usersRes.data; adminFoundItemsCache = itemsRes.data;
            renderAdminList();
        }

        function renderAdminList() {
             const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
             const container = document.getElementById('adminList');
             const filteredUsers = adminUsersCache.filter(u => u.email.toLowerCase().includes(searchTerm));
             const pending = filteredUsers.filter(u => !u.is_authorized);
             const approved = filteredUsers.filter(u => u.is_authorized);
             
             let html = "";
             if (adminFoundItemsCache.length > 0) {
                 html += `<h3 class="text-sm font-bold text-green-600 uppercase mt-2 mb-1">Oggetti Ritrovati</h3>`;
                 html += adminFoundItemsCache.map(item => `
                    <div class="bg-green-50 p-2 border border-green-200 rounded mb-2 text-xs">
                        <div class="flex justify-between font-bold mb-1"><span>${item.titolo}</span><span class="text-gray-400">${new Date(item.created_at).toLocaleDateString()}</span></div>
                        <p class="mb-2 text-gray-600 truncate">Utente: ${item.profiles?.email}</p>
                        <div class="flex gap-2 justify-end">
                            <button onclick="adminContactUser('${item.user_id}', '${item.id}', '${item.titolo.replace(/'/g, "\\'")}')" class="text-blue-600 underline bg-white px-2 py-1 rounded border shadow-sm">üí¨ Chiedi conferma</button>
                            <button onclick="deleteItem(${item.id})" class="text-red-600 underline bg-white px-2 py-1 rounded border shadow-sm">üóëÔ∏è Elimina</button>
                        </div>
                    </div>`).join('');
                 html += `<hr class="my-4 border-gray-300">`;
             }
             if(pending.length > 0) {
                html += `<h3 class="text-sm font-bold text-yellow-600 uppercase mt-2 mb-1">Da Approvare (${pending.length})</h3>`;
                html += pending.map(p => `<div class="bg-yellow-50 p-3 rounded border border-yellow-200 mb-2 flex justify-between items-center"><div class="text-xs truncate w-1/2 font-medium">${p.email}</div><button onclick="authorizeUser('${p.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-xs font-bold shadow">‚úÖ Autorizza</button></div>`).join('');
             } else if (!searchTerm) html += `<p class="text-xs text-gray-400 italic mb-4">Nessun utente in attesa.</p>`;
             
             html += `<h3 class="text-sm font-bold text-gray-600 uppercase mt-4 mb-1">Utenti Attivi (${approved.length})</h3>`;
             if(approved.length === 0) html += `<p class="text-xs text-gray-500 italic">Nessun utente trovato.</p>`;
             else {
                 html += approved.map(p => {
                    const isMe = p.id === currentUser.id; const targetIsSuperAdmin = p.is_super_admin; 
                    let badge = ""; if (p.is_admin) badge = "<span class='text-blue-600 font-bold text-[10px]'>ADMIN</span>"; if (targetIsSuperAdmin) badge = "<span class='text-purple-600 font-bold text-[10px] ml-1'>üëë SUPER</span>";
                    const showActions = !isMe && !targetIsSuperAdmin;
                    return `<div class="p-2 border-b flex justify-between items-center"><span class="text-xs truncate w-1/2 flex items-center gap-1">${p.email} ${badge}</span><div class="flex gap-2">${showActions ? (!p.is_admin ? `<button onclick="toggleAdmin('${p.id}', true)" class="text-xs text-blue-600 underline">üëÆ Nomina</button>` : `<button onclick="toggleAdmin('${p.id}', false)" class="text-xs text-gray-400 underline">Rimuovi</button>`) : ''}${showActions ? `<button onclick="toggleBan('${p.id}', ${!p.is_banned})" class="text-xs underline ${p.is_banned ? 'text-green-600' : 'text-red-500'}">${p.is_banned ? 'Riammetti' : 'Banna'}</button>` : ''}</div></div>`}).join('');
             }
             container.innerHTML = html;
        }

        async function authorizeUser(userId) { if(!confirm("Autorizzare?")) return; await supabase.from('profiles').update({ is_authorized: true }).eq('id', userId); loadAdminPanel(); showToast("Autorizzato!"); }
        async function toggleAdmin(userId, state) { if(!confirm(state ? "Nominare Admin?" : "Rimuovere Admin?")) return; await supabase.from('profiles').update({ is_admin: state }).eq('id', userId); showToast("Fatto."); loadAdminPanel(); }
        async function toggleBan(id, state) { if(!confirm(state ? "Bannare?" : "Riammettere?")) return; await supabase.from('profiles').update({ is_banned: state }).eq('id', id); loadAdminPanel(); showToast("Fatto."); }

        init();
    </script>
</body>
</html>
